<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>SpawnEngine Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:system-ui,Arial;margin:24px;max-width:780px}
    input,button{padding:10px;border:1px solid #ddd;border-radius:8px}
    .row{display:flex;gap:8px;align-items:center;margin:10px 0}
    .card{border:1px solid #eee;border-radius:12px;padding:16px;margin:12px 0}
    pre{background:#111;color:#0f0;padding:12px;border-radius:8px;font-size:12px;overflow:auto}
  </style>
</head>
<body>
  <h1>SpawnEngine — Simple Series Viewer</h1>
  <p>
    Paste a <code>TokenPackSeries</code> address, connect wallet and call
    <code>buy()</code> / <code>open()</code> directly.
  </p>

  <div class="card">
    <div class="row">
      <button id="connect">Connect Wallet</button>
      <span id="addr"></span>
    </div>
    <div class="row">
      <label style="min-width:140px">Series</label>
      <input id="seriesAddr" placeholder="0x...TokenPackSeries" style="flex:1">
    </div>
    <div class="row">
      <label style="min-width:140px">Qty to buy</label>
      <input id="qty" value="1" style="width:120px">
    </div>
    <div class="row">
      <button id="btnBuy">Buy Packs</button>
      <button id="btnOpen">Open #1</button>
    </div>
    <pre id="log"></pre>
  </div>

  <p>
    For full Vibe-style marketplace view, go back to
    <a href="../index.html">SpawnEngine main app</a>.
  </p>

  <script type="module">
    import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.min.js";
    let signer, series;
    const $ = id => document.getElementById(id);

    const abi = [
      "function packPrice() view returns (uint256)",
      "function payoutToken() view returns (address)",
      "function buy(uint256 qty)",
      "function open(uint256 tokenId)",
      "function nextId() view returns (uint256)"
    ];

    function log(msg) {
      $("log").textContent += msg + "\n";
    }

    $("connect").onclick = async () => {
      if (!window.ethereum) return alert("Install wallet");
      const provider = new ethers.BrowserProvider(window.ethereum);
      signer = await provider.getSigner();
      const addr = await signer.getAddress();
      $("addr").textContent = addr.slice(0,6)+"…"+addr.slice(-4);
      log("Connected: " + addr);
    };

    function getSeries() {
      const addr = $("seriesAddr").value.trim();
      if (!addr) throw new Error("Missing series address");
      return new ethers.Contract(addr, abi, signer);
    }

    $("btnBuy").onclick = async () => {
      try {
        series = getSeries();
        const qty = BigInt($("qty").value || "1");
        const price = await series.packPrice();
        const total = price * qty;
        log("Buying " + qty + " packs, cost = " + total.toString());
        const tx = await series.buy(qty);
        log("buy() tx: " + tx.hash);
        await tx.wait();
        log("✓ buy() confirmed");
      } catch (e) {
        log("Error: " + (e?.message || e));
      }
    };

    $("btnOpen").onclick = async () => {
      try {
        series = getSeries();
        const nextId = await series.nextId();
        const tokenId = nextId - 1n; // open latest
        log("Opening tokenId " + tokenId.toString());
        const tx = await series.open(tokenId);
        log("open() tx: " + tx.hash);
        await tx.wait();
        log("✓ open() confirmed");
      } catch (e) {
        log("Error: " + (e?.message || e));
      }
    };
  </script>
</body>
</html>
